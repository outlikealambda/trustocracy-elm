<!DOCTYPE HTML>
<html>
  <head>
    <meta charset="UTF-8">
    <script type="text/javascript" src="/dist/elm.js"></script>
    <link rel="stylesheet" href="/css/normalize.css" />
    <link rel="stylesheet" href="/css/fonts.css" />
    <link rel="stylesheet" href="/css/trusto.css" />

  </head>

  <body>
  </body>

  <script type="text/javascript">

    var activeUserJson = window.localStorage.getItem('activeUser');
    var activeUser = activeUserJson ?
      JSON.parse(activeUserJson) :
      null;

    console.log('activeUser is', activeUser);

    var elmApp = Elm.fullscreen(Elm.Main,
      { initialPath: window.location.pathname,
        activeUser: activeUser,
        fbAuth:
          { status: "not_connected",
            authResponse: null },
        fbUser: null });

    elmApp.ports.saveActiveUser.subscribe(function (user) {
      if (user) {
        console.log('saving user to localStorage', user);
        window.localStorage.setItem('activeUser', JSON.stringify(user));
      } else {
        console.log('clearing active user...');
        window.localStorage.removeItem('activeUser');
      }
    });

    // Facebook integration...
    elmApp.ports.fbAuthRequest.subscribe(function (action) {
      if (action === 'login') {
        console.log('logging in...');
        FB.login(handleFacebookLogin, { scope: 'email' });
      } else if (action === 'logout') {
        console.log('logging out...');
        FB.logout(handleFacebookLogout);
      }
    });

    window.fbAsyncInit = function () {

      FB.Event.subscribe('auth.statusChange', handleFacebookStatusChange);

      FB.init({
        appId      : '28453304375',
        version    : 'v2.5',
        status     : true  // responds with auth.statusChange event...
      });
    };

    // async loading of Facebook SDK... should I just load it in a normal script tag?
    (function(d, s, id){
       var js, fjs = d.getElementsByTagName(s)[0];
       if (d.getElementById(id)) {return;}
       js = d.createElement(s); js.id = id;
       js.src = "//connect.facebook.net/en_US/sdk.js";
       console.log('window.fbAsyncInit...');
       fjs.parentNode.insertBefore(js, fjs);
     }(document, 'script', 'facebook-jssdk'));

    // This is called with the results from from FB.getLoginStatus().
    function handleFacebookStatusChange(response) {

      console.log('statusChangeCallback');
      console.log(response);

      console.log('Sending to elm port...');
      elmApp.ports.fbAuth.send({
        status: response.status,
        authResponse : response.authResponse || null
      });

      // The response object is returned with a status field that lets the
      // app know the current login status of the person.
      // Full docs on the response object can be found in the documentation
      // for FB.getLoginStatus().
      // TODO: handle in elm...
      /*
      if (response.status === 'connected') {
        // Logged into your app and Facebook.
        testAPI();
      } else if (response.status === 'not_authorized') {
        // The person is logged into Facebook, but not your app.
        document.getElementById('status').innerHTML = 'Please log ' +
          'into this app.';
      } else {
        // The person is not logged into Facebook, so we're not sure if
        // they are logged into this app or not.
        document.getElementById('status').innerHTML = 'Please log ' +
          'into Facebook.';
      }*/
    }

    function handleFacebookLogin(response) {
      console.log('login', response);
      if (response.authResponse) {
        FB.api('/me', { fields: ['email', 'name'] }, function (response) {
          console.log(response);
          elmApp.ports.fbUser.send(response);
        });
      } else {
        console.log('User cancelled login or did not fully authorize.');
        // TODO: send null response?
      }
    }

    function handleFacebookLogout(response) {
      console.log('logout', response);
      // TODO: check response?
      elmApp.ports.fbUser.send(null);
    }

  </script>

</html>
